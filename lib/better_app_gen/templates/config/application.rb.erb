require_relative "boot"

require "rails"
# Pick the frameworks you want:
require "active_model/railtie"
require "active_job/railtie"
require "active_record/railtie"
# require "active_storage/engine"
require "action_controller/railtie"
require "action_mailer/railtie"
# require "action_mailbox/engine"
# require "action_text/engine"
require "action_view/railtie"
require "action_cable/engine"
# require "rails/test_unit/railtie"

# Require the gems listed in Gemfile, including any gems
# you've limited to :test, :development, or :production.
Bundler.require(*Rails.groups)

module <%= app_name_pascal %>
  class Application < Rails::Application
    # Initialize configuration defaults for originally generated Rails version.
    config.load_defaults 8.0

    # Logging settings
    config.log_level = ENV.fetch("RAILS_LOG_LEVEL", "info")

    # Autoload libs
    config.autoload_lib(ignore: %w[assets tasks generators])

    # Rails web console settings
    config.web_console.permissions = "0.0.0.0/0"

    # I18n default settings
    config.i18n.load_path        += Rails.root.glob("config/locales/**/*.{rb,yml}/*.{rb,yml}/**/*.{rb,yml}/*.{rb,yml}")
    config.i18n.available_locales = [ :<%= locale %> ]
    config.i18n.default_locale    = :<%= locale %>
    config.time_zone              = "<%= timezone %>"

    # Action Dispatch config
    config.public_file_server.enabled = ENV["RAILS_SERVE_STATIC_FILES"].present?

    # Use structure.sql instead of schema.rb
    config.active_record.schema_format = :sql

    # SMTP Settings
    config.action_mailer.delivery_method = :smtp

    unless Rails.env.test?
      config.action_mailer.smtp_settings = {
        address:              ENV.fetch("SMTP_ADDRESS", nil),
        port:                 ENV.fetch("SMTP_PORT", nil).to_i,
        domain:               ENV.fetch("SMTP_DOMAIN", nil),
        user_name:            ENV.fetch("SMTP_USERNAME", nil),
        password:             ENV.fetch("SMTP_PASSWORD", nil),
        authentication:       ENV.fetch("SMTP_AUTHENTICATION", "plain"),
        enable_starttls_auto: ActiveModel::Type::Boolean.new.cast(ENV.fetch("SMTP_ENABLE_STARTTLS_AUTO", true)),
        open_timeout:         ENV.fetch("SMTP_OPEN_TIMEOUT", 5).to_i,
        read_timeout:         ENV.fetch("SMTP_READ_TIMEOUT", 5).to_i
      }
    end

    # Clear hosts
    config.hosts.clear

    # Don't generate system test files.
    config.generators do |g|
      g.orm :active_record, primary_key_type: :uuid
      g.system_tests nil
    end

    # Cache with SolidCache
    config.cache_store = :solid_cache_store

    # ActiveJob with SolidCache
    config.active_job.queue_adapter = :solid_queue
    config.solid_queue.connects_to = { database: { writing: :queue } }
  end
end
